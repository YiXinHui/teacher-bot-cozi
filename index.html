<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—é›¨è€å¸ˆå¾®ä¿¡æˆäº¤AIæ•™ç»ƒ (æ‰£å­ç‰ˆ)</title>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œçœç•¥ä»¥èŠ‚çœç¯‡å¹…ï¼Œç›´æ¥ç”¨ä¹‹å‰çš„å³å¯ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: linear-gradient(135deg, #0052D9 0%, #366EF4 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 400px; overflow: hidden; height: 80vh; max-height: 700px; display: flex; flex-direction: column; }
        .login-page { padding: 40px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .logo { font-size: 40px; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; transition: 0.3s; }
        .input-group input:focus { border-color: #0052D9; outline: none; }
        .btn { width: 100%; padding: 12px; background: #0052D9; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn:hover { background: #003C9D; }
        .error-msg { color: red; font-size: 12px; margin-bottom: 10px; display: none; }
        .chat-page { display: none; flex: 1; flex-direction: column; height: 100%; }
        .chat-header { background: #0052D9; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background: #f5f5f5; }
        .message { margin-bottom: 15px; display: flex; gap: 10px; }
        .message.user { flex-direction: row-reverse; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .message-content { max-width: 75%; padding: 10px 14px; border-radius: 12px; background: white; font-size: 14px; line-height: 1.5; word-wrap: break-word; }
        .message.user .message-content { background: #0052D9; color: white; }
        .input-area { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; resize: none; outline: none; }
        .send-btn { width: 40px; height: 40px; background: #0052D9; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .loading .message-content { color: #888; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginPage" class="login-page">
            <div class="logo">ğŸ¤–</div>
            <h2 style="margin-bottom: 10px;">æ—é›¨è€å¸ˆå¾®ä¿¡æˆäº¤AIæ•™ç»ƒ</h2>
            <p style="color: #666; margin-bottom: 30px; font-size: 14px;">æ‰£å­ç‰ˆ (æ‰‹æœºå·ç™»å½•)</p>
            <div id="errorMsg" class="error-msg">æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯</div>
            <div class="input-group">
                <label>æ‰‹æœºå·</label>
                <input type="text" id="phone" placeholder="ä¾‹å¦‚ï¼š13800138000">
            </div>
            <div class="input-group">
                <label>å¯†ç </label>
                <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <button class="btn" onclick="login()">ç™»å½•</button>
        </div>

        <div id="chatPage" class="chat-page">
            <div class="chat-header">
                <div>
                    <span style="font-size: 14px; opacity: 0.8;">å½“å‰åŠ©æ•™</span>
                    <div style="font-weight: bold;" id="teacherNameDisplay">æ—é›¨è€å¸ˆ</div>
                </div>
                <button onclick="logout()" style="background:none; border:1px solid rgba(255,255,255,0.3); color:white; padding: 4px 10px; border-radius: 12px; cursor: pointer; font-size: 12px;">é€€å‡º</button>
            </div>
            <div id="messages" class="chat-messages">
                <div class="message">
                    <div class="avatar">ğŸ¤–</div>
                    <div class="message-content">ä½ å¥½ï¼æˆ‘æ˜¯æ‰£å­ç‰ˆæ™ºèƒ½åŠ©æ•™ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ ï¼Ÿ</div>
                </div>
            </div>
            <div class="input-area">
                <textarea id="input" class="chat-input" rows="1" placeholder="è¾“å…¥é—®é¢˜..." onkeydown="if(event.keyCode==13 && !event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
                <button class="send-btn" onclick="sendMessage()">â¤</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let currentUser = null;

        function login() {
            const phone = document.getElementById('phone').value.trim();
            const pwd = document.getElementById('password').value.trim();
            const user = STUDENTS_CONFIG.find(s => s.phone === phone && s.password === pwd);
            
            if (user) {
                currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('chatPage').style.display = 'flex';
                document.getElementById('teacherNameDisplay').innerText = user.teacherName;
                document.getElementById('errorMsg').style.display = 'none';
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        function logout() { location.reload(); }

        async function sendMessage() {
            const input = document.getElementById('input');
            const text = input.value.trim();
            if (!text) return;

            addMessage('user', text);
            input.value = '';
            const loadingId = addMessage('ai', 'æ€è€ƒä¸­...', true);

            try {
                // ğŸ”´ æ ¸å¿ƒå˜åŒ–ï¼šå‘é€ç»™ /api/coze
                const response = await fetch('/api/coze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: COZE_CONFIG.token,
                        botId: currentUser.botId, // è¿™é‡Œç”¨ botId
                        message: text,
                        userId: currentUser.phone // ç”¨æ‰‹æœºå·å½“ç”¨æˆ·ID
                    })
                });

                const data = await response.json();
                removeMessage(loadingId);

                if (data.success) {
                    addMessage('ai', data.reply);
                } else {
                    addMessage('ai', `æœåŠ¡é”™è¯¯: ${data.error}`);
                }

            } catch (e) {
                removeMessage(loadingId);
                let errorText = 'è¿æ¥å¤±è´¥';
                if (e.message.includes('404')) errorText = 'æ‰¾ä¸åˆ° api/coze.js æ–‡ä»¶';
                else if (e.message.includes('500')) errorText = 'æ‰£å­å“åº”è¶…æ—¶æˆ–é…ç½®é”™è¯¯';
                else errorText = e.message;
                addMessage('ai', errorText);
            }
        }

        function addMessage(role, text, isLoading = false) {
            const box = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${role} ${isLoading ? 'loading' : ''}`;
            div.id = isLoading ? 'loading-msg' : ('msg-' + Date.now());
            div.innerHTML = `
                <div class="avatar">${role === 'user' ? 'ğŸ§‘â€ğŸ“' : 'ğŸ¤–'}</div>
                <div class="message-content">${text}</div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return div.id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }
    </script>
</body>
</html>
